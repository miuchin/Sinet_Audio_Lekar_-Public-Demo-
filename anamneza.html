<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Anamneza ¬∑ Dijagnostiƒçki vodiƒç (srpski)</title>
    <link rel="icon" href="favicon.ico">
    <!-- Bootstrap 5 + Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background: #f2f5f9; font-family: 'Segoe UI', Roboto, system-ui, sans-serif; font-size: 1rem; line-height: 1.5; }
        .card-header { background-color: #dde9f5; font-weight: 600; }
        .section-title { font-size: 1.25rem; border-left: 6px solid #0d6efd; padding-left: 12px; margin: 20px 0 15px; color: #0b3b5c; }
        .list-group-item { cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .list-group-item:hover { background-color: #e2eaf6; }
        .icd-badge { background-color: #0d6efd; color: white; font-size: 0.75rem; margin-right: 6px; padding: 4px 8px; border-radius: 30px; }
        .export-btn { min-width: 110px; }
        @media print { .no-print, .btn, .navbar { display: none !important; } }
        textarea { min-height: 80px; font-size: 0.95rem; }
        .accordion-button:not(.collapsed) { background-color: #cfe2ff; }
        .footer { font-size: 0.85rem; color: #6c757d; }
        .kopi-btn { background: none; border: none; color: #0d6efd; }
        .pregled-kartica { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); }
        .pretrage-ikona { color: #b02a37; margin-right: 8px; }
        /* veƒái font i proreƒë za ƒçitkost */
        body, input, textarea, select, button { font-size: 1rem; }
        .lead { font-size: 1.1rem; }
    </style>
</head>
<body>

<!-- NAVBAR (srpski) -->
<nav class="navbar navbar-expand-sm navbar-dark bg-primary no-print shadow-sm">
    <div class="container-fluid">
        <span class="navbar-brand"><i class="fas fa-notes-medical me-2"></i>Anamneza ¬∑ Dijagnostika</span>
        <div class="ms-auto">
            <button class="btn btn-sm btn-light me-2" onclick="prikaziFormu()"><i class="fas fa-pen"></i> Nova anamneza</button>
            <button class="btn btn-sm btn-light" onclick="prikaziListu()"><i class="fas fa-list"></i> Lista pacijenata</button>
        </div>
    </div>
</nav>

<div class="container-fluid mt-2 mb-5">
    <!-- Gornji gumbi za brzi export/print -->
    <div class="d-flex flex-wrap gap-2 mb-3 no-print">
        <button class="btn btn-outline-primary btn-sm export-btn" onclick="exportJSON()"><i class="fas fa-download"></i> JSON</button>
        <button class="btn btn-outline-primary btn-sm export-btn" onclick="exportTXT()"><i class="fas fa-file-alt"></i> TXT</button>
        <button class="btn btn-outline-primary btn-sm export-btn" onclick="exportHTML()"><i class="fas fa-code"></i> HTML</button>
        <button class="btn btn-outline-primary btn-sm export-btn" onclick="window.print()"><i class="fas fa-print"></i> ≈†tampaj</button>
        <button class="btn btn-outline-primary btn-sm export-btn" onclick="sendMail()"><i class="fas fa-envelope"></i> E-mail</button>
        <input type="file" id="jsonUpload" accept=".json" style="display: none;" onchange="importJSON(event)">
        <button class="btn btn-outline-secondary btn-sm me-2" onclick="goBackToSinet()"><i class="fas fa-arrow-left"></i> Nazad u SINET</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('jsonUpload').click()"><i class="fas fa-upload"></i> Uvezi JSON</button>
        <button class="btn btn-outline-success btn-sm ms-auto" onclick="kopirajMarkdown()"><i class="fas fa-copy"></i> Kopiraj Rekapitulaciju (md)</button>
        <span class="badge bg-info text-dark d-flex align-items-center ms-2">lokalno ¬∑ /data/anamneza.json</span>
    </div>

    <!-- Glavni red -->
    <div class="row">
        <!-- leva kolona ‚Äì forma / lista -->
        <div class="col-md-8">
            <div id="mainView" class="pregled-kartica"></div>
        </div>
        <!-- desna kolona ‚Äì MKB i preporuke (pro≈°ireno) -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-white fw-bold"><i class="fas fa-book-open me-2 text-primary"></i>MKB-10 pretraga / poglavlja</div>
                <div class="card-body p-2" style="max-height: 340px; overflow-y: auto;">
                    <input class="form-control form-control-sm mb-2" type="text" id="searchICD" placeholder="üîç pretra≈æi ≈°ifru ili naziv..." onkeyup="pretraziMKB()">
                    <div id="icdList" style="font-size:0.9rem;">
                        <!-- MKB poglavlja (uƒçitava se iz JS) -->
                    </div>
                </div>
            </div>
<div class="card shadow-sm border-0 mb-3" id="sinet-link-card">
    <div class="card-header bg-white fw-bold"><i class="fas fa-link me-2 text-success"></i>Povezano u SINET</div>
    <div class="card-body small">
        <div class="text-muted mb-2">Klikni MKB-10 ≈°ifru (desno) da vidi≈° predloge iz <code>/data/sinet_dx_index.json</code> i/ili SINET kataloga.</div>
        <div id="sinetSelectedIcd" class="mb-2"></div>
        <div id="sinetCandidates" style="max-height: 160px; overflow:auto;"></div>
        <div class="d-flex gap-2 mt-2 flex-wrap">
            <button class="btn btn-sm btn-success" type="button" onclick="sinetCreateProtocolAndInsert()">üéµ Ubaci u SINET</button>
            <button class="btn btn-sm btn-outline-success" type="button" onclick="sinetDownloadSharePack()">üì¶ Preuzmi SharePack</button>
            <button class="btn btn-sm btn-outline-secondary" type="button" onclick="sinetOpenGuidePreview()">üßæ Pregled vodiƒça</button>
        </div>
        <div id="sinetLinkStatus" class="mt-2 text-muted"></div>
    </div>
</div>

            <!-- SINET Quick Help (Brza pomoƒá + Hitno/Akutno) -->
            <div class="card shadow-sm border-0 mb-3" id="sinet-quick-card">
                <div class="card-header bg-white fw-bold"><i class="fas fa-kit-medical me-2 text-danger"></i>Brza pomoƒá (Hitno + SOS + Akutno)</div>
                <div class="card-body small">
                    <div class="text-muted mb-2">Preƒçice iz SINET kataloga (npr. <code>*-sos</code>, <code>sys-hitno-*</code>, <code>akutne-povrede-*</code>). Klik = instant ‚ÄúUbaci u SINET‚Äù.</div>
                    <div id="sinetQuickList" style="max-height: 220px; overflow:auto;"></div>
                    <div id="sinetQuickStatus" class="mt-2 text-muted"></div>
                </div>
            </div>



            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-white fw-bold"><i class="fas fa-flask me-2 text-danger"></i>Preporuƒçene pretrage (uz hipertenziju i dr.)</div>
                <div class="card-body small">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-droplet pretrage-ikona"></i> <strong>Laboratorija:</strong> KKS, CRP, glukoza, kreatinin, urea, elektroliti, lipidogram (ukupni holesterol, LDL, HDL, trigliceridi), HbA1c, TSH, ac. mokraƒána</li>
                        <li><i class="fas fa-heart pretrage-ikona"></i> <strong>Kardiovaskularno:</strong> EKG (12 kanala), Holter krvnog pritiska 24h, chokardiografija (UZV srca), Doppler krvnih sudova vrata, ABI indeks</li>
                        <li><i class="fas fa-lungs pretrage-ikona"></i> <strong>Respiratorno:</strong> Spirometrija, RTG pluƒáa i srca, gasne analize</li>
                        <li><i class="fas fa-stethoscope pretrage-ikona"></i> <strong>Imid≈æing:</strong> UZV abdomena (jetra, bubrezi, nadbubre≈æne ≈ælezde), MR/CT po indikaciji (mo≈ædani udar, aneurizma)</li>
                        <li><i class="fas fa-vial pretrage-ikona"></i> <strong>Dodatno:</strong> mikroalbuminurija, fundus oka (hipertenzivna retinopatija), test optereƒáenja glukozom, PSAD (prostata)</li>
                    </ul>
                    <hr>
                    <p class="mb-0"><i class="fas fa-clipboard-check me-1"></i> <strong>Plan praƒáenja:</strong> ponoviti merenje krvnog pritiska u ordinaciji i kod kuƒáe. Ako je pritisak ‚â•140/90 mmHg, uvesti dnevnik i razmotriti farmakoterapiju uz promenu ≈æivotnih navika.</p>
                </div>
            </div>

            <!-- Kratak opis hipertenzije (sa slike) -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Hipertenzija ‚Äì podsetnik</div>
                <div class="card-body small">
                    <p>Hipertenzija je ƒçest faktor rizika za infarkt srca, mo≈ædani udar, o≈°teƒáenje bubrega. Ciljne vrednosti za veƒáinu pacijenata < 140/90 mmHg (za starije i dijabetiƒçare cilj se individualizira).</p>
                    <p><strong>Simptomi:</strong> glavobolja, vrtoglavica, zamuƒáen vid, ote≈æano disanje, krvarenje iz nosa (ƒçesto odsutni ‚Äì tihi ubica).</p>
                    <p><strong>Uzroci:</strong> esencijalna (90-95%): nasleƒëe, gojaznost, sol, stres, alkohol, pu≈°enje, fiziƒçka neaktivnost. Sekundarna: bubre≈æne bolesti, endokrini poremeƒáaji.</p>
                    <p><strong>Obavezne pretrage kod otkrivanja:</strong> EKG, UZV srca, laboratorija (ukljuƒçujuƒái kreatinin, elektroliti, TSH, lipidogram), pregled oƒçnog dna, merenje pritiska na obe ruke.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FOOTER -->
<div class="footer text-center no-print mt-4">¬© Dijagnostiƒçki vodiƒç ‚Äî sinhronizacija sa <code>/data/anamneza.json</code> (server :8000) i localStorage.</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function goBackToSinet(){
      try{
        const p = new URLSearchParams(location.search);
        const back = p.get('back');
        if (back) { location.href = back; return; }
      }catch(_){}
      location.href = 'index.html';
    }
</script>
<script>
    // ================== GLOBALNI PODACI ==================
    // Poku≈°aj uƒçitavanja sa servera (/data/anamneza.json), inaƒçe localStorage
    let pacijenti = [];

    // Inicijalno uƒçitavanje
    ucitajPacijenteSaServera();

    // MKB-10 ‚Äî mini fallback + opcioni full MKB ako postoji data/mkb10_sr.json
    const mkbPoglavlja = [
        { poglavlje: 'I. Zarazne i parazitarne bolesti (A00‚ÄìB99)', sifre: ['A09 (dijareja)', 'A15 (tuberkuloza)', 'B18 (hroniƒçni hepatitis)', 'B20 (HIV)'] },
        { poglavlje: 'II. Neoplazme (C00‚ÄìD48)', sifre: ['C34 (karcinom pluƒáa)', 'C50 (karcinom dojke)', 'C61 (karcinom prostate)', 'C18 (karcinom debelog creva)'] },
        { poglavlje: 'III. Bolesti krvi i imunog sistema (D50‚ÄìD89)', sifre: ['D50 (sideropenijska anemija)', 'D69 (trombocitopenija)'] },
        { poglavlje: 'IV. Endokrine bolesti (E00‚ÄìE90)', sifre: ['E10 (diabetes tip 1)', 'E11 (diabetes tip 2)', 'E05 (hipertireoza)', 'E03 (hipotireoza)', 'E66 (gojaznost)'] },
        { poglavlje: 'V. Mentalni poremeƒáaji (F00‚ÄìF99)', sifre: ['F32 (depresija)', 'F41 (anksiozni poremeƒáaj)', 'F10 (alkoholizam)'] },
        { poglavlje: 'VI. Bolesti nervnog sistema (G00‚ÄìG99)', sifre: ['G40 (epilepsija)', 'G43 (migrena)', 'G45 (TIA)'] },
        { poglavlje: 'VII. Bolesti oka (H00‚ÄìH59)', sifre: ['H40 (glaukom)', 'H25 (katarakta)'] },
        { poglavlje: 'VIII. Bolesti uva (H60‚ÄìH95)', sifre: ['H81 (vertigo)'] },
        { poglavlje: 'IX. Cirkulacijski sistem (I00‚ÄìI99)', sifre: ['I10 (hipertenzija)', 'I20 (angina pektoris)', 'I50 (srƒçana insuficijencija)', 'I63 (mo≈ædani infarkt)', 'I70 (ateroskleroza)'] },
        { poglavlje: 'X. Respiratorne bolesti (J00‚ÄìJ99)', sifre: ['J45 (astma)', 'J44 (KOPB)', 'J15 (pneumonija)', 'J20 (akutni bronhitis)'] },
        { poglavlje: 'XI. Digestivne bolesti (K00‚ÄìK95)', sifre: ['K25 (ulkus ≈æeluca)', 'K29 (gastritis)', 'K80 (kolelitijaza)', 'K74 (fibroza jetre)'] },
        { poglavlje: 'XII. Ko≈æa (L00‚ÄìL99)', sifre: ['L40 (psorijaza)'] },
        { poglavlje: 'XIII. Mi≈°iƒáno-ko≈°tani sistem (M00‚ÄìM99)', sifre: ['M17 (gonartroza)', 'M54 (lumbalni bol)', 'M81 (osteoporoza)'] },
        { poglavlje: 'XIV. Genitourinarne bolesti (N00‚ÄìN99)', sifre: ['N18 (HBI)', 'N40 (hiperplazija prostate)', 'N39 (UTI)'] }
    ];

    // Full MKB (ako je dostupan)
    let mkbFull = null; // array: [{code,title},...]

    function normStr(s){
        return String(s||'')
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g,'')
          .replace(/\s+/g,' ')
          .trim();
    }

    function codeKey(code){
        const m = String(code||'').toUpperCase().match(/^([A-Z])(\d{2})/);
        if(!m) return null;
        return { L: m[1].charCodeAt(0), N: parseInt(m[2],10) };
    }
    function inRange(code, start, end){
        const c = codeKey(code);
        const a = codeKey(start);
        const b = codeKey(end);
        if(!c||!a||!b) return false;
        const v = c.L*100 + c.N;
        const va = a.L*100 + a.N;
        const vb = b.L*100 + b.N;
        return v>=va && v<=vb;
    }

    const mkbChapters = [
        { title:'I. Zarazne i parazitarne bolesti (A00‚ÄìB99)', start:'A00', end:'B99' },
        { title:'II. Neoplazme (C00‚ÄìD48)', start:'C00', end:'D48' },
        { title:'III. Bolesti krvi i imunog sistema (D50‚ÄìD89)', start:'D50', end:'D89' },
        { title:'IV. Endokrine bolesti (E00‚ÄìE90)', start:'E00', end:'E90' },
        { title:'V. Mentalni poremeƒáaji (F00‚ÄìF99)', start:'F00', end:'F99' },
        { title:'VI. Bolesti nervnog sistema (G00‚ÄìG99)', start:'G00', end:'G99' },
        { title:'VII. Bolesti oka (H00‚ÄìH59)', start:'H00', end:'H59' },
        { title:'VIII. Bolesti uva (H60‚ÄìH95)', start:'H60', end:'H95' },
        { title:'IX. Cirkulacijski sistem (I00‚ÄìI99)', start:'I00', end:'I99' },
        { title:'X. Respiratorne bolesti (J00‚ÄìJ99)', start:'J00', end:'J99' },
        { title:'XI. Digestivne bolesti (K00‚ÄìK93)', start:'K00', end:'K93' },
        { title:'XII. Ko≈æa (L00‚ÄìL99)', start:'L00', end:'L99' },
        { title:'XIII. Mi≈°iƒáno-ko≈°tani sistem (M00‚ÄìM99)', start:'M00', end:'M99' },
        { title:'XIV. Genitourinarne bolesti (N00‚ÄìN99)', start:'N00', end:'N99' },
        { title:'XV. Trudnoƒáa, poroƒëaj i babinje (O00‚ÄìO99)', start:'O00', end:'O99' },
        { title:'XVI. Perinatalni period (P00‚ÄìP96)', start:'P00', end:'P96' },
        { title:'XVII. Kongenitalne malformacije (Q00‚ÄìQ99)', start:'Q00', end:'Q99' },
        { title:'XVIII. Simptomi i abnormalni nalazi (R00‚ÄìR99)', start:'R00', end:'R99' },
        { title:'XIX. Povrede i posledice (S00‚ÄìT98)', start:'S00', end:'T98' },
        { title:'XX. Spoljni uzroci (V01‚ÄìY98)', start:'V01', end:'Y98' },
        { title:'XXI. Faktori i kontakti (Z00‚ÄìZ99)', start:'Z00', end:'Z99' },
        { title:'XXII. Posebne ≈°ifre (U00‚ÄìU99)', start:'U00', end:'U99' },
    ];

    async function tryLoadMKB10(){
        const urls = ['/data/mkb10_sr.json','./data/mkb10_sr.json','../data/mkb10_sr.json'];
        for(const u of urls){
            try{
                const r = await fetch(u, { cache:'no-store' });
                if(!r.ok) continue;
                const j = await r.json();
                const arr = Array.isArray(j) ? j : (Array.isArray(j?.entries) ? j.entries : null);
                if(arr && arr.length){
                    mkbFull = arr
                      .filter(x => x && (x.code || x.sifra) )
                      .map(x => ({ code: String(x.code || x.sifra).trim(), title: String(x.title || x.naziv || x.opis || '').trim() }))
                      .filter(x => x.code);
                    break;
                }
            }catch(_){ }
        }
    }

    function renderMkbFallback(){
        let html = '';
        mkbPoglavlja.forEach(p => {
            html += `<div class="mb-2"><strong>${p.poglavlje}</strong><br>`;
            p.sifre.forEach(s => html += `<span class="icd-badge">${s.split(' ')[0]}</span> ${s}<br>`);
            html += `</div><hr class="my-1">`;
        });
        document.getElementById('icdList').innerHTML = html;
    }

    function renderMkbFull(){
        const MAX_PER_CH = 80;
        let html = `<div class="text-muted mb-2">Uƒçitana je puna MKB-10 baza (${mkbFull.length} ≈°ifri). Klik na ≈°ifru ‚ûú SINET predlog.</div>`;
        for(const ch of mkbChapters){
            const list = mkbFull.filter(e => inRange(e.code, ch.start, ch.end));
            if(!list.length) continue;
            list.sort((a,b)=>a.code.localeCompare(b.code));
            const shown = list.slice(0, MAX_PER_CH);
            html += `<details class="mb-2"><summary><strong>${ch.title}</strong> <span class="text-muted">(${list.length})</span></summary>`;
            html += `<div class="mt-2">`;
            for(const e of shown){
                const t = e.title ? ` ‚Äî ${e.title}` : '';
                html += `<div><span class="icd-badge">${e.code}</span> ${e.code}${t}</div>`;
            }
            if(list.length > MAX_PER_CH){
                html += `<div class="text-muted mt-1">Prikazano ${MAX_PER_CH} od ${list.length}. Koristi pretragu za ostale.</div>`;
            }
            html += `</div></details>`;
        }
        document.getElementById('icdList').innerHTML = html;
    }

    function prikaziMKB(){
        if(mkbFull && mkbFull.length){
            renderMkbFull();
        }else{
            renderMkbFallback();
        }
    }

    window.pretraziMKB = function() {
        const q = normStr(document.getElementById('searchICD').value);
        if(!q){ prikaziMKB(); return; }

        // Full search
        if(mkbFull && mkbFull.length){
            const out = mkbFull.filter(e => (normStr(e.code).includes(q) || normStr(e.title).includes(q))).slice(0, 200);
            if(!out.length){
                document.getElementById('icdList').innerHTML = '<p class="text-muted">Nema rezultata.</p>';
                return;
            }
            let html = `<div class="text-muted mb-2">Rezultati (prvih ${out.length}):</div>`;
            out.forEach(e => {
                const t = e.title ? ` ‚Äî ${e.title}` : '';
                html += `<div><span class="icd-badge">${e.code}</span> ${e.code}${t}</div>`;
            });
            document.getElementById('icdList').innerHTML = html;
            return;
        }

        // Fallback mini search
        let filtered = mkbPoglavlja.map(p => {
            let sifreF = p.sifre.filter(s => s.toLowerCase().includes(q) || p.poglavlje.toLowerCase().includes(q));
            return { ...p, sifre: sifreF };
        }).filter(p => p.sifre.length > 0 || p.poglavlje.toLowerCase().includes(q));

        let html = '';
        filtered.forEach(p => {
            html += `<div class="mb-2"><strong>${p.poglavlje}</strong><br>`;
            p.sifre.forEach(s => html += `<span class="icd-badge">${s.split(' ')[0]}</span> ${s}<br>`);
            html += `</div><hr class="my-1">`;
        });
        if (filtered.length === 0) html = '<p class="text-muted">Nema rezultata.</p>';
        document.getElementById('icdList').innerHTML = html;
    };

    // ========== Server operacije (/data/anamneza.json na localhost serveru) ==========
    const SERVER_URL = '/data/anamneza.json';

    async function ucitajPacijenteSaServera() {
        try {
            let response = await fetch(SERVER_URL);
            if (response.ok) {
                pacijenti = await response.json();
                if (!Array.isArray(pacijenti)) pacijenti = [];
            } else {
                // fallback na localStorage
                let local = localStorage.getItem('anamneza_pacijenti');
                pacijenti = local ? JSON.parse(local) : [];
            }
        } catch (e) {
            console.warn('Server nije dostupan, koristi localStorage.');
            let local = localStorage.getItem('anamneza_pacijenti');
            pacijenti = local ? JSON.parse(local) : [];
        }
        // osiguraj bar jednog primera ako je prazno
        if (pacijenti.length === 0) pacijenti = [kreirajPrimerPacijenta()];
        localStorage.setItem('anamneza_pacijenti', JSON.stringify(pacijenti)); // sync
        // poku≈°aj full MKB uƒçitavanja (ako postoji)
        await tryLoadMKB10();
        prikaziListu();
        prikaziMKB();
    }

    async function snimiNaServer() {
        let podaci = JSON.stringify(pacijenti, null, 2);
        try {
            let response = await fetch(SERVER_URL, {
                method: 'PUT', // ili POST, ali json-server koristi PUT za celu kolekciju
                headers: { 'Content-Type': 'application/json' },
                body: podaci
            });
            if (!response.ok) throw new Error('Server nije dozvolio upis');
        } catch (e) {
            console.warn('Ne mogu da snimim na server, ƒçuvam samo u localStorage.');
        }
        localStorage.setItem('anamneza_pacijenti', JSON.stringify(pacijenti));
    }

    function kreirajPrimerPacijenta() {
        return {
            id: 'p1',
            osobni: { ime: 'Marko', prezime: 'Periƒá', godina: '1955', mjesto: 'Split', adresa: 'Poljiƒçka 12', zanimanje: 'umirovljeni bravar', bracno: 'o≈æenjen', djeca: 'dvoje' },
            razlog: 'Hitni prijem ‚Äì bol u prsima i ote≈æano disanje',
            obiteljska: 'Otac: hipertenzija, majka: diabetes tip 2, sestra: zdrava',
            osobna: { djeƒçje: 'vodenice, ospice', dosadasnje: '2018. hipertenzija, 2020. operacija ingvinalne kile', sadasnja: 'Bol u prsima zadnja 2 sata, ≈°iri se u lijevu ruku, znojenje' },
            seksualna: 'uredna, bez smetnji',
            socijalna: '≈æivi sa suprugom u stanu (lift), primanja prosjeƒçna',
            radna: '40 godina u strojobravariji, izlo≈æen buci i metalnoj pra≈°ini',
            epidemioloska: 'nedavno putovanje u Maƒëarsku, bez kontakta sa zarazom',
            funkcije: 'mokraƒáa: uredna, stolica: uredna, apetit: smanjen, gubitak te≈æine: ne',
            navike: 'alkohol: 2 ƒça≈°ice vina/dan, cigarete: 20/dan 35 godina, kava: 3 dnevno',
            alergije: 'negira',
            lijekovi: 'Enalapril 10mg 1x1, Aspirin 100mg',
            status: {
                opci: 'Pri svijesti, kontaktibilan, eupnoiƒçan, ko≈æa bljedunjava, RR 160/95, puls 88/min',
                glava: 'uredna',
                oci: 'zjenice izokoriƒçne, uredna reakcija',
                usi: 'bezbolne',
                usna: 'sluznica vla≈æna, jezik neoblo≈æen',
                vrat: 'pokretan, vratne vene uredne',
                prsni: 'simetriƒçan, uredno pomiƒçan',
                pluca: 'vezikularno disanje, bez hropaca',
                srce: 'ritmiƒçno, tonovi jasni, sistoliƒçki ≈°um 2/6 na vrhu',
                trbuh: 'mekan, bezbolan, jetra nije poveƒáana',
                kraljesnica: 'bezbolna',
                ekstremiteti: 'bez edema',
                zakljucak: 'Sumnja na STEMI? Angina pektoris, hipertenzija'
            }
        };
    }

    // ========== Pregled / forme (srpski jezik, pobolj≈°ana ƒçitljivost) ==========
    function prikaziFormu(editId = null) {
        let html = `
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white"><i class="fas fa-notes-medical me-2"></i>Unos nove anamneze (standardni obrazac)</div>
                <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
        `;
        html += `
            <form id="anamnezaForm" onsubmit="spisiPacijenta(event)">
                <div class="accordion" id="accordionForm">
                    <!-- 1. Osobni podaci -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#f1">1. Liƒçni podaci</button></h2>
                        <div id="f1" class="accordion-collapse collapse show" data-bs-parent="#accordionForm">
                            <div class="accordion-body row g-2">
                                <div class="col-6"><label>Ime</label><input type="text" id="ime" class="form-control" value="Marko"></div>
                                <div class="col-6"><label>Prezime</label><input type="text" id="prezime" class="form-control" value="Periƒá"></div>
                                <div class="col-4"><label>God. roƒë.</label><input type="text" id="godina" class="form-control" value="1955"></div>
                                <div class="col-4"><label>Mesto</label><input type="text" id="mjesto" class="form-control" value="Split"></div>
                                <div class="col-4"><label>Adresa</label><input type="text" id="adresa" class="form-control" value="Poljiƒçka 12"></div>
                                <div class="col-4"><label>Zanimanje</label><input type="text" id="zanimanje" class="form-control" value="bravar"></div>
                                <div class="col-4"><label>Braƒçno</label><input type="text" id="bracno" class="form-control" value="o≈æenjen"></div>
                                <div class="col-4"><label>Deca</label><input type="text" id="djeca" class="form-control" value="dvoje"></div>
                            </div>
                        </div>
                    </div>
                    <!-- 2. Razlog dolaska -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#f2">2. Razlog dolaska</button></h2>
                        <div id="f2" class="accordion-collapse collapse" data-bs-parent="#accordionForm">
                            <div class="accordion-body"><textarea id="razlog" class="form-control">Hitni prijem ‚Äì bol u prsima, ote≈æano disanje</textarea></div>
                        </div>
                    </div>
                    <!-- 3. Porodiƒçna anamneza -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#f3">3. Porodiƒçna anamneza</button></h2>
                        <div id="f3" class="accordion-collapse collapse" data-bs-parent="#accordionForm">
                            <div class="accordion-body"><textarea id="obiteljska" class="form-control">Otac hipertenzija, majka diabetes</textarea></div>
                        </div>
                    </div>
                    <!-- 4. Liƒçna anamneza -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#f4">4. Liƒçna anamneza</button></h2>
                        <div id="f4" class="accordion-collapse collapse" data-bs-parent="#accordionForm">
                            <div class="accordion-body">
                                <label>Deƒçje bolesti</label><textarea id="djecije" class="form-control mb-2">vodenice, ospice</textarea>
                                <label>Dosada≈°nje bolesti</label><textarea id="dosadasnje" class="form-control mb-2">hipertenzija od 2018, operacija kile 2020</textarea>
                                <label>Sada≈°nja bolest</label><textarea id="sadasnja" class="form-control">Bol u prsima 2h, znojenje, muƒçnina</textarea>
                            </div>
                        </div>
                    </div>
                    <!-- 5. Socijalna, radna, epidemiolo≈°ka -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#f5">5. Socijalna / radna / epidemiolo≈°ka</button></h2>
                        <div id="f5" class="accordion-collapse collapse" data-bs-parent="#accordionForm">
                            <div class="accordion-body">
                                <label>Seksualna</label><textarea id="seksualna" class="form-control mb-2">uredna</textarea>
                                <label>Socijalna</label><textarea id="socijalna" class="form-control mb-2">≈æivi sa suprugom, lift, primanja solidna</textarea>
                                <label>Radna</label><textarea id="radna" class="form-control mb-2">bravar 40 god, izlo≈æen pra≈°ini</textarea>
                                <label>Epidemiolo≈°ka</label><textarea id="epidemioloska" class="form-control">put u Maƒëarsku, bez zaraze</textarea>
                            </div>
                        </div>
                    </div>
                    <!-- 6. Funkcije, navike, alergije, lekovi -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#f6">6. Funkcije / navike / alergije / lekovi</button></h2>
                        <div id="f6" class="accordion-collapse collapse" data-bs-parent="#accordionForm">
                            <div class="accordion-body">
                                <label>Funkcije (mokraƒáa, stolica, apetit, menstruacija...)</label><textarea id="funkcije" class="form-control mb-2">mokraƒáa uredna, stolica uredna, apetit smanjen</textarea>
                                <label>Navike (alkohol, cigarete, kafa, tjelovje≈æba, droge)</label><textarea id="navike" class="form-control mb-2">2 vina/dan, 20 cig/d, 3 kafe</textarea>
                                <label>Alergije</label><input id="alergije" class="form-control mb-2" value="negira">
                                <label>Lekovi koje uzima (doze)</label><textarea id="lijekovi" class="form-control">Enalapril 10mg, Aspirin 100mg</textarea>
                            </div>
                        </div>
                    </div>
                    <!-- 7. Status praesens -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#f7">7. Status praesens</button></h2>
                        <div id="f7" class="accordion-collapse collapse" data-bs-parent="#accordionForm">
                            <div class="accordion-body">
                                <label>Op≈°ti status</label><textarea id="opci" class="form-control mb-2">Pri svijesti, kontaktibilan, RR 160/95, puls 88, afebrilan</textarea>
                                <label>Glava, oƒçi, u≈°i, usna duplja</label><textarea id="glava" class="form-control mb-2">glava uredna, zjenice izokoriƒçne, sluznica vla≈æna</textarea>
                                <label>Vrat, grudni ko≈°, pluƒáa</label><textarea id="vratPrsni" class="form-control mb-2">vrat pokretan, pluƒáa: vezikularno disanje</textarea>
                                <label>Srce, trbuh, kiƒçma, ekstremiteti</label><textarea id="srceOstalo" class="form-control mb-2">srce ritmiƒçno, ≈°um 2/6; trbuh mekan; ekstremiteti bez edema</textarea>
                                <label>Zakljuƒçak (kliniƒçki utisak)</label><textarea id="zakljucak" class="form-control">Sumnja na akutni koronarni sindrom, hipertenzija</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success mt-3 w-100"><i class="fas fa-save"></i> Saƒçuvaj anamnezu</button>
            </form>
        `;
        html += `</div></div>`;
        document.getElementById('mainView').innerHTML = html;
    }

    function prikaziListu() {
        let pac = pacijenti;
        let html = `<div class="card shadow-sm border-0"><div class="card-header bg-secondary text-white">Pregled svih anamneza (${pac.length})</div><div class="list-group list-group-flush" style="max-height: 70vh; overflow-y: auto;">`;
        pac.forEach((p, idx) => {
            let imePrez = p.osobni?.ime + ' ' + p.osobni?.prezime || 'nepoznato';
            html += `<div class="list-group-item d-flex justify-content-between align-items-center" onclick="prikaziDetalj(${idx})">
                <span><i class="fas fa-user-injured me-2"></i><strong>${imePrez}</strong> (${p.osobni?.godina || '?'})</span>
                <small class="text-secondary">${p.razlog?.substring(0,35)}‚Ä¶</small>
            </div>`;
        });
        html += `</div></div>`;
        if (pac.length === 0) html += '<p class="mt-2">Nema spremljenih anamneza.</p>';
        document.getElementById('mainView').innerHTML = html;
    }

    
function prikaziDetalj(index) {
    const p = pacijenti[index];

    function escHtml(v){
        return String(v ?? '').replace(/[&<>"']/g, (c) => ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[c]));
    }
    function showVal(v){
        const s = String(v ?? '').trim();
        return s ? escHtml(s) : '<span class="text-muted">‚Äî</span>';
    }
    function row(label, value){
        return `
          <div class="col-12 col-lg-6">
            <div class="p-2 rounded-3 border bg-white">
              <div class="small text-muted fw-bold" style="letter-spacing:.2px;">${escHtml(label)}</div>
              <div>${showVal(value)}</div>
            </div>
          </div>`;
    }
    function block(title, rowsHtml){
        if(!rowsHtml) return '';
        return `
          <div class="mb-3">
            <div class="fw-bold mb-2" style="color:#0b3b5c;">${escHtml(title)}</div>
            <div class="row g-2">${rowsHtml}</div>
          </div>`;
    }

    const o = p?.osobni || {};
    const os = p?.osobna || {};
    const st = p?.status || {};

    const human =
      block('1) Osnovni podaci', [
        row('Ime', o.ime),
        row('Prezime', o.prezime),
        row('Godina roƒëenja', o.godina),
        row('Mesto', o.mjesto),
        row('Adresa', o.adresa),
        row('Zanimanje', o.zanimanje),
        row('Braƒçno stanje', o.bracno),
        row('Deca', o.djeca),
      ].join('')) +

      block('2) Razlog dolaska', row('Razlog', p?.razlog).replace('col-12 col-lg-6','col-12')) +

      block('3) Porodiƒçna anamneza', row('Porodiƒçna', p?.obiteljska).replace('col-12 col-lg-6','col-12')) +

      block('4) Liƒçna anamneza', [
        row('Deƒçje bolesti', os['djeƒçje'] || os['djecije'] || os['djecje']),
        row('Dosada≈°nje bolesti', os.dosadasnje),
        row('Sada≈°nja bolest', os.sadasnja),
      ].join('')) +

      block('5) Socijalna / radna / epidemiolo≈°ka', [
        row('Seksualna', p?.seksualna),
        row('Socijalna', p?.socijalna),
        row('Radna', p?.radna),
        row('Epidemiolo≈°ka', p?.epidemioloska),
      ].join('')) +

      block('6) Funkcije / navike / alergije / lekovi', [
        row('Funkcije', p?.funkcije),
        row('Navike', p?.navike),
        row('Alergije', p?.alergije),
        row('Lekovi', p?.lijekovi),
      ].join('')) +

      block('7) Status praesens', [
        row('Op≈°ti status', st.opci),
        row('Glava / oƒçi / u≈°i / usna duplja', st.glava),
        row('Vrat / grudni ko≈° / pluƒáa', st.vratPrsni),
        row('Srce / trbuh / kiƒçma / ekstremiteti', st.srceOstalo),
        row('Zakljuƒçak (kliniƒçki utisak)', st.zakljucak),
      ].join(''));

    let sadrzaj = `
        <div class="card shadow-sm border-0">
            <div class="card-header bg-info text-white d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div><i class="fas fa-file-medical me-2"></i>Detalji anamneze</div>
              <div class="btn-group btn-group-sm" role="group" aria-label="Prikaz">
                <button id="btnHuman" class="btn btn-light" type="button" onclick="setDetailMode('human')">üëÅ ƒåitljivo</button>
                <button id="btnJson" class="btn btn-outline-light" type="button" onclick="setDetailMode('json')">{ } JSON</button>
              </div>
            </div>
            <div class="card-body" style="max-height:70vh; overflow-y:auto; background:#fafbfe;">
                <div id="detailHuman">${human}</div>
                <pre id="detailJson" class="mt-2" style="display:none; white-space: pre-wrap; font-family: ui-monospace, Menlo, monospace; font-size:0.95rem;">${escHtml(JSON.stringify(p, null, 2))}</pre>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-warning" onclick="prikaziFormu()">Nova anamneza</button>
                <button class="btn btn-sm btn-danger" onclick="obrisi(${index})">Obri≈°i</button>
            </div>
        </div>
    `;
    document.getElementById('mainView').innerHTML = sadrzaj;

    // zapamti poslednje izabranog pacijenta (za integrativni vodiƒç)
    try{ localStorage.setItem('ANAMNEZA_LAST_PATIENT', JSON.stringify(p)); }catch(_){ }

    // default: human view
    setDetailMode('human');
}

function setDetailMode(mode){
    const h = document.getElementById('detailHuman');
    const j = document.getElementById('detailJson');
    const bh = document.getElementById('btnHuman');
    const bj = document.getElementById('btnJson');
    if(!h || !j) return;
    if(mode === 'json'){
      h.style.display = 'none';
      j.style.display = 'block';
      if(bh) bh.className = 'btn btn-outline-light';
      if(bj) bj.className = 'btn btn-light';
    } else {
      h.style.display = 'block';
      j.style.display = 'none';
      if(bh) bh.className = 'btn btn-light';
      if(bj) bj.className = 'btn btn-outline-light';
    }
}
function spisiPacijenta(e) {
        e.preventDefault();
        const novi = {
            id: 'p' + Date.now(),
            osobni: {
                ime: document.getElementById('ime')?.value || '',
                prezime: document.getElementById('prezime')?.value || '',
                godina: document.getElementById('godina')?.value || '',
                mjesto: document.getElementById('mjesto')?.value || '',
                adresa: document.getElementById('adresa')?.value || '',
                zanimanje: document.getElementById('zanimanje')?.value || '',
                bracno: document.getElementById('bracno')?.value || '',
                djeca: document.getElementById('djeca')?.value || ''
            },
            razlog: document.getElementById('razlog')?.value || '',
            obiteljska: document.getElementById('obiteljska')?.value || '',
            osobna: {
                djeƒçje: document.getElementById('djecije')?.value || '',
                dosadasnje: document.getElementById('dosadasnje')?.value || '',
                sadasnja: document.getElementById('sadasnja')?.value || ''
            },
            seksualna: document.getElementById('seksualna')?.value || '',
            socijalna: document.getElementById('socijalna')?.value || '',
            radna: document.getElementById('radna')?.value || '',
            epidemioloska: document.getElementById('epidemioloska')?.value || '',
            funkcije: document.getElementById('funkcije')?.value || '',
            navike: document.getElementById('navike')?.value || '',
            alergije: document.getElementById('alergije')?.value || '',
            lijekovi: document.getElementById('lijekovi')?.value || '',
            status: {
                opci: document.getElementById('opci')?.value || '',
                glava: document.getElementById('glava')?.value || '',
                vratPrsni: document.getElementById('vratPrsni')?.value || '',
                srceOstalo: document.getElementById('srceOstalo')?.value || '',
                zakljucak: document.getElementById('zakljucak')?.value || ''
            }
        };
        pacijenti.push(novi);
        snimiNaServer().then(() => {
            alert('Anamneza saƒçuvana (server + lokalno)');
            prikaziListu();
        });
    }

    function obrisi(index) {
        if (confirm('Obrisati?')) {
            pacijenti.splice(index,1);
            snimiNaServer().then(() => prikaziListu());
        }
    }

    // Export / Import (ista imena funkcija)
    function exportJSON() { downloadFile(JSON.stringify(pacijenti,null,2), 'anamneza.json', 'application/json'); }
    function exportTXT() { 
        let txt = '';
        pacijenti.forEach((p,i) => { txt += `PACIJENT ${i+1}\n${JSON.stringify(p,null,2)}\n\n`; });
        downloadFile(txt, 'anamneza.txt', 'text/plain');
    }
    function exportHTML() {
        let html = `<html><head><meta charset="UTF-8"><title>Anamneze</title></head><body>`;
        pacijenti.forEach(p => { html += `<pre>${JSON.stringify(p,null,2)}</pre><hr>`; });
        // VA≈ΩNO: u ovom <script> bloku ne sme da se pojavi literalni ZATVARAJUƒÜI SCRIPT tag (inaƒçe browser prekida parsiranje).
        html += '\n' + '<scr' + 'ipt src="js/anamneza-sinet-bridge.js?v=15.7.6.7"></scr' + 'ipt>\n</body></html>';
        downloadFile(html, 'anamneza.html', 'text/html');
    }
    function downloadFile(content, fileName, mime) {
        const blob = new Blob([content], {type: mime});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
    }
    function importJSON(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                let uvezeni = JSON.parse(e.target.result);
                if (Array.isArray(uvezeni)) {
                    pacijenti = uvezeni;
                    snimiNaServer().then(() => prikaziListu());
                } else alert('Neispravan JSON (treba biti niz)');
            } catch (er) { alert('Gre≈°ka u JSON formatu'); }
        };
        reader.readAsText(file);
    }
    function sendMail() {
        const subject = 'Anamneza podaci';
        const body = encodeURIComponent(JSON.stringify(pacijenti, null, 2));
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }

    function kopirajMarkdown() {
        let md = `# Rekapitulacija anamneza i plan rada\n\nDatum: ${new Date().toLocaleString('sr-RS')}\n\n`;
        md += `## Ukupan broj pacijenata: ${pacijenti.length}\n\n`;
        pacijenti.forEach((p, i) => {
            md += `### ${i+1}. ${p.osobni?.ime || ''} ${p.osobni?.prezime || ''} (${p.osobni?.godina || '?'})\n`;
            md += `- Razlog: ${p.razlog || '/'}\n- Sada≈°nja bolest: ${p.osobna?.sadasnja || '/'}\n- Status (zakljuƒçak): ${p.status?.zakljucak || '/'}\n- Lekovi: ${p.lijekovi || '/'}\n- Preporuƒçene pretrage: KKS, EKG, chokardiografija, troponin, UZV abdomen, Holter krvnog pritiska, lipidogram, kreatinin, TSH\n\n`;
        });
        md += `## Plan daljnjeg rada\n- Za svakog pacijenta potrebno je uzeti ciljanu anamnezu, fizikalni pregled, osnovne laboratorijske pretrage, EKG, chokardiografiju kod srƒçanih simptoma, UZV abdomena kod sumnje na patologiju probavnog sustava, RTG pluƒáa kod respiratornih tegoba. Pratiti vrednosti krvnog pritiska, ≈°eƒáera, prema MKB-10 grupama razmotriti specijalistiƒçke konzilije. Svu dokumentaciju arhivirati u JSON formatu (data/anamneza.json).\n`;
        navigator.clipboard.writeText(md).then(() => alert('Markdown rekapitulacija kopirana u meƒëuspremnik!'));
    }

    window.onload = () => { /* ucitavanje se vr≈°i u ucitajPacijenteSaServera() */ };
</script>

<script src="js/anamneza-sinet-bridge.js?v=15.7.6.7"></script>
</body>
</html>
